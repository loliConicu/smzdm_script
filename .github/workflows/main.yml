name: SMZDM è°ƒè¯•æµ‹è¯•

on:
  workflow_dispatch:

jobs:
  debug-smzdm:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        npm install got@11 crypto-js --no-package-lock
    
    - name: è°ƒè¯•ç¯å¢ƒå˜é‡å’Œè„šæœ¬
      env:
        SMZDM_COOKIE: ${{ secrets.SMZDM_COOKIE }}
        SMZDM_SK: ${{ secrets.SMZDM_SK }}
        SMZDM_COMMENT: ${{ secrets.SMZDM_COMMENT }}
        SMZDM_CROWD_SILVER_5: ${{ secrets.SMZDM_CROWD_SILVER_5 }}
        SMZDM_TASK_TESTING: ${{ secrets.SMZDM_TASK_TESTING }}
      run: |
        echo "=== ç¯å¢ƒå˜é‡æ£€æŸ¥ ==="
        if [ -z "$SMZDM_COOKIE" ]; then
          echo "âŒ SMZDM_COOKIE ä¸ºç©ºï¼è¿™æ˜¯è„šæœ¬æ— è¾“å‡ºçš„ä¸»è¦åŸå› ï¼"
          echo "è¯·æ£€æŸ¥ GitHub Secrets ä¸­çš„é…ç½®"
          exit 1
        else
          echo "âœ… SMZDM_COOKIE å·²é…ç½® (é•¿åº¦: ${#SMZDM_COOKIE})"
          echo "å‰30ä¸ªå­—ç¬¦: ${SMZDM_COOKIE:0:30}..."
        fi
        
        echo ""
        echo "=== è„šæœ¬æ–‡ä»¶æ£€æŸ¥ ==="
        ls -la smzdm_*.js
        
        echo ""
        echo "=== è¿è¡Œå•ä¸ªè„šæœ¬è¿›è¡Œæµ‹è¯• ==="
        echo "æ·»åŠ è°ƒè¯•è¾“å‡ºåˆ°è„šæœ¬..."
        
        # ä¸´æ—¶ä¿®æ”¹è„šæœ¬æ·»åŠ è°ƒè¯•ä¿¡æ¯
        if [ -f "smzdm_checkin.js" ]; then
          echo "console.log('ğŸš€ SMZDMç­¾åˆ°è„šæœ¬å¼€å§‹è¿è¡Œ...');" > debug_checkin.js
          echo "console.log('Cookieé•¿åº¦:', process.env.SMZDM_COOKIE ? process.env.SMZDM_COOKIE.length : 'æœªè®¾ç½®');" >> debug_checkin.js
          echo "console.log('å½“å‰æ—¶é—´:', new Date().toISOString());" >> debug_checkin.js
          echo "" >> debug_checkin.js
          cat smzdm_checkin.js >> debug_checkin.js
          
          echo "è¿è¡Œè°ƒè¯•ç‰ˆæœ¬çš„ç­¾åˆ°è„šæœ¬ï¼š"
          timeout 60 node debug_checkin.js || echo "è„šæœ¬è¿è¡Œè¶…æ—¶æˆ–å‡ºé”™"
        fi
        
        echo ""
        echo "=== æ£€æŸ¥è„šæœ¬å‰å‡ è¡Œå†…å®¹ ==="
        head -20 smzdm_checkin.js
        
        echo ""
        echo "=== æœç´¢å¯èƒ½çš„é€€å‡ºæ¡ä»¶ ==="
        grep -n "process.exit\|return\|throw\|console.log" smzdm_checkin.js | head -10
