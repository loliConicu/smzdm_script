name: SMZDM è‡ªåŠ¨ç­¾åˆ°

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©ä¸Šåˆ8ç‚¹å’Œæ™šä¸Š8ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'    # åŒ—äº¬æ—¶é—´ä¸Šåˆ8ç‚¹ (UTC+8)
    - cron: '0 12 * * *'   # åŒ—äº¬æ—¶é—´æ™šä¸Š8ç‚¹ (UTC+8)
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # Push è§¦å‘ï¼ˆå¯é€‰ï¼‰
  push:
    branches: [ main, master ]

jobs:
  smzdm-checkin:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    # è®¾ç½® Node.js ç¯å¢ƒ
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # å®‰è£…ä¾èµ–
    - name: å®‰è£…ä¾èµ–
      run: |
        # ç›´æ¥å®‰è£…å¿…éœ€çš„ä¾èµ–åŒ…
        npm install got@11 crypto-js --no-package-lock
        echo "ä¾èµ–å®‰è£…å®Œæˆ"
    
    # è¿è¡Œ SMZDM ç­¾åˆ°è„šæœ¬
    - name: è¿è¡Œ SMZDM ç­¾åˆ°
      env:
        # ä» GitHub Secrets ä¸­è·å–ç¯å¢ƒå˜é‡
        SMZDM_COOKIE: ${{ secrets.SMZDM_COOKIE }}
        SMZDM_SK: ${{ secrets.SMZDM_SK }}
        SMZDM_USER_AGENT_APP: ${{ secrets.SMZDM_USER_AGENT_APP }}
        SMZDM_USER_AGENT_WEB: ${{ secrets.SMZDM_USER_AGENT_WEB }}
        SMZDM_COMMENT: ${{ secrets.SMZDM_COMMENT }}
        SMZDM_CROWD_SILVER_5: ${{ secrets.SMZDM_CROWD_SILVER_5 }}
        SMZDM_CROWD_KEYWORD: ${{ secrets.SMZDM_CROWD_KEYWORD }}
        SMZDM_TASK_TESTING: ${{ secrets.SMZDM_TASK_TESTING }}
        # æ¨é€é€šçŸ¥ç›¸å…³ï¼ˆå¯é€‰ï¼‰
        BARK_PUSH: ${{ secrets.BARK_PUSH }}
        TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
        TG_USER_ID: ${{ secrets.TG_USER_ID }}
        QYWX_KEY: ${{ secrets.QYWX_KEY }}
        DD_BOT_TOKEN: ${{ secrets.DD_BOT_TOKEN }}
        DD_BOT_SECRET: ${{ secrets.DD_BOT_SECRET }}
        SCKEY: ${{ secrets.SCKEY }}
      run: |
        # æ˜¾ç¤ºå½“å‰ç›®å½•æ–‡ä»¶
        echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -la
        
        # æ˜¾ç¤º Node.js å’Œ npm ç‰ˆæœ¬
        echo "Node.js ç‰ˆæœ¬: $(node --version)"
        echo "npm ç‰ˆæœ¬: $(npm --version)"
        
        # è¿è¡Œä¸»è¦çš„ SMZDM è„šæœ¬
        echo "å¼€å§‹è¿è¡Œ SMZDM è„šæœ¬..."
        
        # æŸ¥æ‰¾å¹¶è¿è¡Œæ‰€æœ‰ smzdm_ å¼€å¤´çš„ js æ–‡ä»¶
        SCRIPT_COUNT=0
        for script in smzdm_*.js; do
          if [ -f "$script" ]; then
            echo "================================================"
            echo "è¿è¡Œè„šæœ¬: $script"
            echo "================================================"
            node "$script"
            SCRIPT_RESULT=$?
            if [ $SCRIPT_RESULT -eq 0 ]; then
              echo "âœ… è„šæœ¬ $script è¿è¡ŒæˆåŠŸ"
            else
              echo "âŒ è„šæœ¬ $script è¿è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $SCRIPT_RESULT"
            fi
            SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
            echo "ç­‰å¾… 3 ç§’åè¿è¡Œä¸‹ä¸€ä¸ªè„šæœ¬..."
            sleep 3
          fi
        done
        
        if [ $SCRIPT_COUNT -eq 0 ]; then
          echo "âš ï¸  æœªæ‰¾åˆ°ä»»ä½• smzdm_*.js è„šæœ¬æ–‡ä»¶"
          echo "é¡¹ç›®æ–‡ä»¶åˆ—è¡¨ï¼š"
          find . -name "*.js" -type f
        else
          echo "ğŸ‰ æ€»å…±è¿è¡Œäº† $SCRIPT_COUNT ä¸ªè„šæœ¬"
        fi
    
    # ä¸Šä¼ æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
    - name: ä¸Šä¼ è¿è¡Œæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: smzdm-logs-${{ github.run_number }}
        path: |
          *.log
          logs/
        retention-days: 7
